## 安装配置CAS

### 基础环境安装

搭建CAS单点登录系统，首先需要基础环境的部署。主要包括Windows/Linux/Java/Maven/GIT/Tomcat等，基础环境的部署不是本文的描写重点，本文仅做简要说明，如有疑问可以邮件咨询。

### Windows

Windows 10，安装有JDK/GIT/Maven等工具，主要功能是下载CAS服务端和客户端源码，并进行编译打包，上传到Linux服务器上进行部署。同时利用Chrome浏览器对安装之后的环境进行检验。

### Linux

Ubuntu 16.04.1 LTS，安装有JDK、Tomcat等工具，主要作为CAS Server和Web Server的宿主环境。

### JDK

Linux服务器端安装JDK主要是作为Tomcat的运行时环境，并提供keytool等工具进行HTTPS配置；Windows客户端安装JDK主要是作为Maven的运行时环境。

jiangxin@tomcat:~$ java -version
java version "1.8.0_121"
Java(TM) SE Runtime Environment (build 1.8.0_121-b13)
Java HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)

PS C:\Users\jiang> java -version
java version "1.8.0_102"
Java(TM) SE Runtime Environment (build 1.8.0_102-b14)
Java HotSpot(TM) 64-Bit Server VM (build 25.102-b14, mixed mode)


### GIT
安装在Windows机器，主要用于下载并及时更新CAS Server和Client源码。
PS C:\Users\jiang> git --version
git version 2.8.3.windows.1

### Maven

安装在Windows机器，主要作用是编译打包。
PS C:\Users\jiang> mvn -v
Apache Maven 3.3.9 (bb52d8502b132ec0a5a3f4c09453c07478323dc5; 2015-11-11T00:41:47+08:00)
Maven home: C:\apache-maven-3.3.9
Java version: 1.8.0_102, vendor: Oracle Corporation
Java home: C:\Java\jdk1.8.0_102\jre
Default locale: zh_CN, platform encoding: GBK
OS name: "windows 10", version: "10.0", arch: "amd64", family: "dos"

### Tomcat

安装在Linux，安装包为：
apache-tomcat-8.5.14.tar.gz
为了更好的模拟单点登录，需要安装三个Tomcat实例，其中一个作为CAS Server，另外两个作为CAS Client。具体分配

安装过程为：
jiangxin@tomcat:/usr/local$ sudo mkdir tomcat
jiangxin@tomcat:/usr/local$ sudo chown -R jiangxin:jiangxin tomcat/
jiangxin@tomcat:/usr/local$ cd tomcat/
jiangxin@tomcat:/usr/local/tomcat$ ls
jiangxin@tomcat:/usr/local/tomcat$ tar -zxvf apache-tomcat-8.5.14.tar.gz
jiangxin@tomcat:/usr/local/tomcat$ cd

jiangxin@tomcat:~$ sudo vim /etc/profile

export CATALINA_BASE=/usr/local/tomcat/apache-tomcat-8.5.14
export CATALINA_HOME=/usr/local/tomcat/apache-tomcat-8.5.14
export PATH=$PATH:$CATALINA_HOME/lib:$CATALINA_HOME/bin

jiangxin@tomcat:~$ source /etc/profile

jiangxin@tomcat:~$ startup.sh ; tailf $CATALINA_HOME/logs/catalina.out
Using CATALINA_BASE:   /usr/local/tomcat/apache-tomcat-8.5.14
Using CATALINA_HOME:   /usr/local/tomcat/apache-tomcat-8.5.14
Using CATALINA_TMPDIR: /usr/local/tomcat/apache-tomcat-8.5.14/temp
Using JRE_HOME:        /usr/local/java/jdk1.8.0_121
#限于篇幅，此处有省略
05-May-2017 20:27:53.487 信息 [main] org.apache.catalina.startup.Catalina.start Server startup in 1633 ms


在浏览器中访问下面地址，查看能否正常访问：

http://192.168.1.130:8080/


![](https://raw.githubusercontent.com/jiangxincode/PicGo/master/aloys_build_manual/image191.png)

jiangxin@tomcat:~$ shutdown.sh 
Using CATALINA_BASE:   /usr/local/tomcat/apache-tomcat-8.5.14
Using CATALINA_HOME:   /usr/local/tomcat/apache-tomcat-8.5.14
Using CATALINA_TMPDIR: /usr/local/tomcat/apache-tomcat-8.5.14/temp
Using JRE_HOME:        /usr/local/java/jdk1.8.0_121
Using CLASSPATH:       /usr/local/tomcat/apache-tomcat-8.5.14/bin/bootstrap.jar:/usr/local/tomcat/apache-tomcat-8.5.14/bin/tomcat-juli.jar

### 安装CAS服务端

在较新的CAS版本中不在提供CAS服务端和客户端的安装包，都是依靠下载源码，重新打包。如果对本文的安装内容有疑问可以参考CAS的官网：

https://apereo.github.io/cas/5.0.x/installation/Maven-Overlay-Installation.html
https://github.com/apereo/cas-overlay-template

正常情况下应该在服务器上进行maven编译，这样才能保证编译的JDK版本和运行时的版本一致，但是此处为了方便，直接在Windows编译。

PS C:\Users\jiang> cd D:\temp\Java\
PS D:\temp\Java> git clone https://github.com/apereo/cas-overlay-template.git
Cloning into 'cas-overlay-template'...
remote: Counting objects: 566, done.
remote: Compressing objects: 100% (12/12), done.
remote: Total 566 (delta 4), reused 0 (delta 0), pack-reused 550 eceiving objects:  96% (544/566), 116.00 KiB | 79.00 KiB/
Receiving objects: 100% (566/566), 188.70 KiB | 79.00 KiB/s, done.
Resolving deltas: 100% (275/275), done.
Checking connectivity... done.
PS D:\temp\Java> cd .\cas-overlay-template\
PS D:\temp\Java\cas-overlay-template> .\build.cmd package
[INFO] Scanning for projects...
[INFO]
[INFO] Using the MultiThreadedBuilder implementation with a thread count of 5
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building cas-overlay 1.0
由于篇幅原因，此处有省略
[INFO] Packaging webapp
[INFO] Assembling webapp [cas-overlay] in [D:\temp\Java\cas-overlay-template\target\cas]
[info] Copying manifest...
[INFO] Processing war project
[INFO] Processing overlay [ id org.apereo.cas:cas-server-webapp]
[INFO] Webapp assembled in [2685 msecs]
[INFO] Building war: D:\temp\Java\cas-overlay-template\target\cas.war
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 06:34 min (Wall Clock)
[INFO] Finished at: 2017-05-05T20:06:02+08:00
[INFO] Final Memory: 13M/200M
[INFO] ------------------------------------------------------------------------


把cas-overlay-template\target\cas.war上传到/usr/local/tomcat/apache-tomcat-8.5.14/webapps

重新启动tomcat

05-May-2017 20:39:10.561 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log Server version:        Apache Tomcat/8.5.14
由于篇幅原因，此处有省略
05-May-2017 20:39:11.026 信息 [localhost-startStop-1] org.apache.catalina.startup.HostConfig.deployWAR Deploying web application archive /usr/local/tomcat/apache-tomcat-8.5.14/webapps/cas.war
05-May-2017 20:39:20.915 信息 [localhost-startStop-1] org.apache.jasper.servlet.TldScanner.scanJars At least one JAR was scanned for TLDs yet contained no TLDs. Enable debug logging for this logger for a complete list of JARs that were scanned but no TLDs were found in them. Skipping unneeded JARs during scanning can improve startup time and JSP compilation time.


  __  ____     _     ____  __  
 / / / ___|   / \   / ___| \ \ 
| | | |      / _ \  \___ \  | |
| | | |___  / ___ \  ___) | | |
| |  \____|/_/   \_\|____/  | |
 \_\                       /_/ 

CAS Version: 5.0.5
Apache Tomcat Version: Apache Tomcat/8.5.14
Build Date/Time: 2017-04-21T03:24:20Z
System Temp Directory: /usr/local/tomcat/apache-tomcat-8.5.14/temp
Java Home: /usr/local/java/jdk1.8.0_121/jre
Java Vendor: Oracle Corporation
Java Version: 1.8.0_121
JCE Installed: no
OS Architecture: amd64
OS Name: Linux
OS Version: 4.4.0-72-generic


2017-05-05 20:39:29,134 INFO [org.apereo.cas.web.CasWebApplicationServletInitializer] - <The following profiles are active: native>

在浏览器中范围如下地址，查看能否访问：
http://192.168.1.130:8080/cas/login


![](https://raw.githubusercontent.com/jiangxincode/PicGo/master/aloys_build_manual/image192.png)

使用casuser/Mellon进行登录（application.properties中配置用户名和密码），查看是否登录成功。

![](https://raw.githubusercontent.com/jiangxincode/PicGo/master/aloys_build_manual/image193.png)

### 配置数字证书

CAS要求CAS Server和CAS Client以及客户端浏览器端全部使用https访问，所以需要配置证书。

正常情况下，数字证书的生成，分发，使用是在多台机器上，以本文搭建的SSO系统为例，在A机器（CA）上生成证书，然后将证书（包括私钥和公钥）分发到B机器（SSO Server），B机器根据该证书导出公钥分发给C机器（SSO Client），此时B和C即可正常建立连接。同时当D机器（客户端浏览器）与A机器交互时即可在A机器上下载公钥，进行连接。
但为了方便测试，本文中A、B、C机器为一台。

下边的命令，会创建一条证书记录并写入cacerts。证书记录信息包含该条证书的私钥，公钥和对应的数字证书的信息。

```shell
jiangxin@tomcat:~$ keytool -genkey -alias castest -keyalg RSA -keystore /usr/local/java/jdk1.8.0_121/jre/lib/security/cacerts 
输入密钥库口令:  # 按照JDK后，默认的密钥库密码为changeit
您的名字与姓氏是什么? # 名字与姓氏为CAS跳转域名
  [Unknown]:  cas.sso.com
您的组织单位名称是什么?
  [Unknown]:  castest
您的组织名称是什么?
  [Unknown]:  castest
您所在的城市或区域名称是什么?
  [Unknown]:  nanjing
您所在的省/市/自治区名称是什么?
  [Unknown]:  jiangsu
该单位的双字母国家/地区代码是什么?
  [Unknown]:  cn
CN=cas.sso.com, OU=castest, O=castest, L=nanjing, ST=jiangsu, C=cn是否正确?
  [否]:  y

输入 <castest> 的密钥口令
	(如果和密钥库口令相同, 按回车):
```

可使用如下命令查看证书信息：
jiangxin@tomcat:~$ keytool -list -keystore "$JAVA_HOME/jre/lib/security/cacerts" -alias castest
输入密钥库口令:  
castest, 2017-5-7, PrivateKeyEntry, 
证书指纹 (SHA1): 9A:9A:DF:AB:18:B7:D9:81:8D:24:BA:E3:73:99:67:CE:58:B0:3A:CD

如果要更新证书，可以先删除原证书,再导入新证书:
jiangxin@tomcat:~$ keytool -delete -alias castest -keystore /usr/local/java/jdk1.8.0_121/jre/lib/security/cacerts

接下来修改server.xml文件
jiangxin@tomcat:~$ cp /usr/local/tomcat/apache-tomcat-8.5.14/conf/server.xml /usr/local/tomcat/apache-tomcat-8.5.14/conf/server.xml.bak
jiangxin@tomcat:~$ vim /usr/local/tomcat/apache-tomcat-8.5.14/conf/server.xml

```xml
<Connector port="8443" protocol="org.apache.coyote.http11.Http11NioProtocol"
               maxThreads="150" SSLEnabled="true"  scheme="https" secure="true" maxHttpHeaderSize="8192"
               clientAuth="false" sslProtocol="TLS" 
            keystoreFile="/usr/local/java/jdk1.8.0_121/jre/lib/security/cacerts" 
            keystorePass="changeit">
</Connector>
```

重启tomcat，访问下面地址，查看是否能够正常访问：
https://192.168.1.130:8443/cas

![](https://raw.githubusercontent.com/jiangxincode/PicGo/master/aloys_build_manual/image194.png)

![](https://raw.githubusercontent.com/jiangxincode/PicGo/master/aloys_build_manual/image195.png)


![](https://raw.githubusercontent.com/jiangxincode/PicGo/master/aloys_build_manual/image196.png)




由于本文所部署的环境是CAS Server和CAS Client在一台服务器上，所以不需要单独将公钥导出到CAS Client上，但是如果需要，可以参考下面的导入导出过程。

导出数字证书，数字证书包含三部分信息：证书元数据信息，序列号，过期时间等、所有者信息，姓名、地区等、所有者公钥；相比于在keystore中的信息，没有所有者的密钥，所有者的密钥只有所有者自己知道，而此处的数字证书是要分发到公网上的。

jiangxin@tomcat:~$ keytool -export -file ssokey/castest.crt -alias castest -keystore ssokey/castest
输入密钥库口令:  
存储在文件 <ssokey/castest.crt> 中的证书


jiangxin@tomcat:~$ keytool -import -keystore "$JAVA_HOME/jre/lib/security/cacerts" -file ssokey/castest.crt -alias castest
输入密钥库口令:  
keytool 错误: java.io.IOException: Keystore was tampered with, or password was incorrect
jiangxin@tomcat:~$ keytool -import -keystore "$JAVA_HOME/jre/lib/security/cacerts" -file ssokey/castest.crt -alias castest
输入密钥库口令:  
所有者: CN=cas.sso.com, OU=castest, O=castest, L=nanjing, ST=jiangsu, C=cn
发布者: CN=cas.sso.com, OU=castest, O=castest, L=nanjing, ST=jiangsu, C=cn
序列号: 3cc98964
有效期开始日期: Sun May 07 09:03:47 CST 2017, 截止日期: Sat Aug 05 09:03:47 CST 2017
证书指纹:
	 MD5: F4:B8:E4:B1:07:EE:86:45:C7:96:5F:FA:EF:E9:5C:11
	 SHA1: D0:7B:BB:30:0C:D3:8A:49:C9:89:3B:E0:C4:C0:98:30:74:E3:15:98
	 SHA256: 4B:AB:EA:C1:06:3F:0D:3B:A2:C9:3C:F7:45:B6:CF:66:EA:BE:B3:6A:42:61:05:E3:C4:D4:AE:DC:0C:DC:20:31
	 签名算法名称: SHA256withRSA
	 版本: 3

扩展: 

#1: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: D0 C7 06 22 8B 57 71 E4   39 08 E5 05 F9 5B B4 2D  ...".Wq.9....[.-
0010: ED 9F 92 28                                        ...(
]
]

是否信任此证书? [否]:  y
证书已添加到密钥库中

### 安装CAS客户端

建立客户端工程，参考：

https://bitbucket.org/jiangxincode/casclient/

使用maven打包，得到casclient.war，上传到服务器上

### 验证

验证之前先在Windows和Linux机器的hosts文件中加入：
192.168.1.130   cas.sso.com


重新启动Tomcat容器，在浏览器访问如下地址：
https://cas.sso.com:8443/casclient/index.jsp
会发现浏览器被重定向到如下地址：
https://cas.sso.com:8443/cas/login?service=https%3A%2F%2Fcas.sso.com%3A8443%2Fcasclient%2Findex.jsp
输入casuser/Mellon之后，浏览器会跳转到下面的地址
https://cas.sso.com:8443/casclient/index.jsp;jsessionid=23551AEBF9B7B61431D0CC942F923771

### 配置日志路径

为了防止在不同地方启动tomcat，导致日志位置不同，不方便查找，修改一下日志路径。

jiangxin@tomcat:/usr/local/tomcat/apache-tomcat-8.5.14/webapps/cas/WEB-INF/classes$ cp log4j2.xml log4j2.xml.bak
jiangxin@tomcat:/usr/local/tomcat/apache-tomcat-8.5.14/webapps/cas/WEB-INF/classes$ vim log4j2.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!-- Specify the refresh internal in seconds. -->
<Configuration monitorInterval="10">
    <Properties>
        <Property name="CAS_LOG_DIR">/usr/local/tomcat/apache-tomcat-8.5.14/logs/cas</Property>
    </Properties>
    <Appenders>
        <Console name="console" target="SYSTEM_OUT">
            <PatternLayout pattern="%d %p [%c] - &lt;%m&gt;%n"/>
        </Console>

        <RollingFile name="file" fileName="${CAS_LOG_DIR}/cas.log" append="true"
                     filePattern="cas-%d{yyyy-MM-dd-HH}-%i.log">
            <PatternLayout pattern="%d %p [%c] - &lt;%m&gt;%n"/>
            <Policies>
                <OnStartupTriggeringPolicy />
                <SizeBasedTriggeringPolicy size="10 MB"/>
                <TimeBasedTriggeringPolicy />
            </Policies>
        </RollingFile>
        <RollingFile name="auditlogfile" fileName="${CAS_LOG_DIR}/cas_audit.log" append="true"
                     filePattern="cas_audit-%d{yyyy-MM-dd-HH}-%i.log">
            <PatternLayout pattern="%d %p [%c] - %m%n"/>
            <Policies>
                <OnStartupTriggeringPolicy />
                <SizeBasedTriggeringPolicy size="10 MB"/>
                <TimeBasedTriggeringPolicy />
            </Policies>
        </RollingFile>

        <RollingFile name="perfFileAppender" fileName="${CAS_LOG_DIR}/perfStats.log" append="true"
                     filePattern="perfStats-%d{yyyy-MM-dd-HH}-%i.log">
            <PatternLayout pattern="%m%n"/>
            <Policies>
                <OnStartupTriggeringPolicy />
                <SizeBasedTriggeringPolicy size="10 MB"/>
                <TimeBasedTriggeringPolicy />
            </Policies>
        </RollingFile>

        <CasAppender name="casAudit">
            <AppenderRef ref="auditlogfile" />
        </CasAppender>
        <CasAppender name="casFile">
            <AppenderRef ref="file" />
        </CasAppender>
        <CasAppender name="casConsole">
            <AppenderRef ref="console" />
        </CasAppender>
        <CasAppender name="casPerf">
            <AppenderRef ref="perfFileAppender" />
        </CasAppender>
</Appenders>
#限于篇幅，此处有省略
</Configuration>
```

### 其它配置

CAS支持的配置很多，此处不一一说明，有需要的可以参考下面的链接：

https://github.com/apereo/cas
CAS protocol: https://apereo.github.io/cas/5.0.x/protocol/CAS-Protocol.html
CAS Client集群环境的问题及解决方案: https://yq.aliyun.com/articles/49871
cas系列文章: http://www.cnblogs.com/vhua/tag/cas/
cas单点登录配置速成: http://www.blogjava.net/goodlyts/archive/2009/10/20/299091.html